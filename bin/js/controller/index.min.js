!function i(o,s,c){function l(t,e){if(!s[t]){if(!o[t]){var r="function"==typeof require&&require;if(!e&&r)return r(t,!0);if(u)return u(t,!0);var n=new Error("Cannot find module '"+t+"'");throw n.code="MODULE_NOT_FOUND",n}var a=s[t]={exports:{}};o[t][0].call(a.exports,function(e){return l(o[t][1][e]||e)},a,a.exports,i,o,s,c)}return s[t].exports}for(var u="function"==typeof require&&require,e=0;e<c.length;e++)l(c[e]);return l}({1:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./index"),a=e("./eventListener"),i=e("./connectedDevice"),o=a.EventListener.get(),s=(c.prototype.initMessageHandler=function(){this.airConsole.onMessage=function(e,t){if(t&&0===e){console.log("Got message from server",t);var r="SERVER_"+t.action;o.trigger(r,t.data)}}},c.prototype.onUpdateServerData=function(e){this.updateServerCallbacks.add(e)},c.prototype.updateServerData=function(){var t=this;this.updateServerCallbacks.forEach(function(e){return e(t.serverData)})},c.prototype.currentPlayerData=function(){var t=this;return console.table("currentPlayerData playerData",this.playerData),console.table("currentPlayerData id",this.id),this.playerData.filter(function(e){return e.id===t.id})[0]},c.prototype.sendControllerData=function(e){e.id=this.id,this.notifyServer(e)},c.prototype.subscribeToAirConsole=function(){var r=this;this.airConsole.onMessage=function(e,t){if(t)switch(t.transactionType){case n.TransactionType.PlayerData:console.log("received player data",t),r.playerData=t.playerData;break;case n.TransactionType.ObjectData:r.objectData=t.objectData;break;case n.TransactionType.ServerData:r.serverData=t.serverData,r.updateServerData();break;default:console.error("client onMessage switch",t)}else console.error("client onMessage",t)}},c.prototype.toggleAngryDad=function(){console.table("toggleAngryDad playerData",this.playerData),console.table("toggleAngryDad id",this.id);var e=this.currentPlayerData();return void 0===e.isAngryDad?e.isAngryDad=!1:e.isAngryDad=!e.isAngryDad,this.notifyServer(e),e.isAngryDad},c.prototype.changeAppearance=function(e){var t=this.currentPlayerData();return t.characterAppearanceType=e,this.notifyServer(t),t.characterAppearanceType},c.prototype.interacting=function(e){var t=this.currentPlayerData();return t.playerState=e,this.notifyServer(t),t.playerState},c.prototype.notifyServer=function(e){this.airConsole.message(AirConsole.SCREEN,e)},c.prototype.getTime=function(){return this.serverData.timerValueInSeconds},c);function c(){var t=this;this.id=0,this.playerData=[],this.objectData=[],this.updateServerCallbacks=new Set,this.serverData=new n.ServerData(30,n.ServerState.initial),this.awaitReady=new Promise(function(e){t.airConsole=new AirConsole,t.initMessageHandler(),t.airConsole.onDeviceStateChange=function(t,r){try{i.getDevice(t).updateState(r)}catch(e){new i.ConnectedDevice(t).updateState(r)}},o.on("SERVER_updateState",function(e){console.log("game state changed",e.state),e.state,"choose"===e.state&&t.airConsole.setCustomDeviceState({wantAngry:.5<Math.random()})})})}r.Client=s},{"./connectedDevice":2,"./eventListener":3,"./index":4}],2:[function(e,t,r){"use strict";var n=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,a,i=r.call(e),o=[];try{for(;(void 0===t||0<t--)&&!(n=i.next()).done;)o.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o},a=this&&this.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(n(arguments[t]));return e};Object.defineProperty(r,"__esModule",{value:!0});var i=e("./eventListener").EventListener.get(),o=new Map;r.getDevice=function(e){if(!o.has(e))throw new Error("The device does not exist: "+e);return o.get(e)},r.getAllDevices=function(){return a(o.values())};var s=0,c=(l.prototype.disconnect=function(){o.delete(this.deviceId),i.trigger("deviceDisconnected",this)},l.prototype.updateState=function(e){console.log("update state"),this.stateData=e},l.prototype.updateCustomState=function(e){console.log("update custom state"),this.customStateData=e},l.prototype.toJson=function(){return{internalID:this.internalID,deviceId:this.deviceId}},l);function l(e){this.deviceId=e,this.internalID=s++,console.log("client connected",e),o.set(e,this),i.trigger("deviceJoined",this)}r.ConnectedDevice=c},{"./eventListener":3}],3:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=(a.get=function(){return void 0===this.instance&&(this.instance=new a),this.instance},a.prototype.on=function(e,t){return void 0===this.listener[e]&&(this.listener[e]=[]),this.listener[e].push(t),t},a.prototype.off=function(e,t){if(void 0!==this.listener[e]){var r=this.listener[e].indexOf(t);-1!==r&&this.listener[e].splice(r,1)}return t},a.prototype.trigger=function(e,t){void 0!==this.listener[e]&&this.listener[e].forEach(function(e){return e(t)})},a);function a(){this.listener={}}r.EventListener=n},{}],4:[function(e,t,r){"use strict";function n(e){for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t])}Object.defineProperty(r,"__esModule",{value:!0}),n(e("./client")),n(e("./server"));function a(e,t,r){this.x=e,this.y=t,this.id=r,this.transactionType=i.PlayerData,this.playerState=u.idle,this.isAngryDad=!1,this.characterAppearanceType=p.wichtel1}var i,o,s;r.PlayerData=a,(o=i=r.TransactionType||(r.TransactionType={}))[o.ServerData=0]="ServerData",o[o.PlayerData=1]="PlayerData",o[o.ControllerData=2]="ControllerData",o[o.ObjectData=3]="ObjectData",(s=r.ServerState||(r.ServerState={}))[s.initial=0]="initial",s[s.lobby=1]="lobby",s[s.characterSelection=2]="characterSelection",s[s.running=3]="running",s[s.final=4]="final";function c(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.x=e,this.y=t,this.id=0,this.transactionType=i.ControllerData}r.ControllerData=c;function l(e,t){void 0===e&&(e=30),this.timerValueInSeconds=e,this.serverState=t}var u,d,p,h;r.ServerData=l,(d=u=r.PlayerState||(r.PlayerState={}))[d.idle=0]="idle",d[d.dead=1]="dead",d[d.running=2]="running",d[d.interacting=3]="interacting",(h=p=r.CharacterAppearanceType||(r.CharacterAppearanceType={}))[h.wichtel1=0]="wichtel1",h[h.wichtel2=1]="wichtel2",h[h.wichtel3=2]="wichtel3",h[h.wichtel4=3]="wichtel4";function v(e,t,r,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),this.x=e,this.y=t,this.damage=r,this.objectId=n}r.ObjectData=v},{"./client":1,"./server":5}],5:[function(e,t,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var i=e("./index"),n=e("./connectedDevice"),r=e("./eventListener"),o=e("./server/gameStateJoin"),s=r.EventListener.get();a.OBJECTDATAMAXHEALTH=10;var c=(l.prototype.initTick=function(){var r=this,n=performance.now();setInterval(function(){var e=performance.now(),t=e-n;n=e,r.gameState.tick(t)},1e3/60)},l.prototype.initMessageHandler=function(){this.airConsole.onMessage=function(e,t){t&&s.trigger("airConsoleMessage",[e,t])}},l.prototype.subscribeToAirConsole=function(){this.airConsole.onConnect=function(e){},this.airConsole.onDisconnect=function(e){n.getDevice(e).disconnect()},this.airConsole.onDeviceStateChange=function(t,r){try{n.getDevice(t).updateState(r)}catch(e){new n.ConnectedDevice(t).updateState(r)}},this.airConsole.onCustomDeviceStateChange=function(t,r){try{n.getDevice(t).updateCustomState(r)}catch(e){new n.ConnectedDevice(t).updateCustomState(r)}}},l.prototype.onUpdateServerState=function(e){this.updateControllerCallbacks.add(e)},l.prototype.updateServerState=function(){var t=this;this.updateServerCallbacks.forEach(function(e){return e(t.serverData.serverState)})},l.prototype.onUpdateControllerData=function(e){this.updateControllerCallbacks.add(e)},l.prototype.updateControllerData=function(t){this.updateControllerCallbacks.forEach(function(e){return e(t)})},l.prototype.createAndUpdatePlayer=function(t){var e=this.playerData.find(function(e){return e.id===t.id});e?this.updatePlayer(t):(e=new i.PlayerData(0,0,t.id),this.playerData.push(e),this.startAfterFirstPlayerJoined())},l.prototype.startAfterFirstPlayerJoined=function(){var e=this;1==this.playerData.length&&(this.serverData.serverState=i.ServerState.lobby,this.updateServerState(),this.serverStateUpdate(30,i.ServerState.characterSelection,function(){console.log("changed server state to character selection"),e.serverStateUpdate(15,i.ServerState.running,function(){e.serverStateUpdate(300,i.ServerState.final,function(){})})}))},l.prototype.serverStateUpdate=function(e,t,r){var n=this;setTimeout(function(){n.serverData.serverState=t,n.updateServerState(),n.serverData.serverState===i.ServerState.running&&n.setAngryDad(),r()},1e3*e)},l.prototype.setAngryDad=function(){var e=this.playerData.filter(function(e){e.isAngryDad}),t=e.length;if(console.log("wantAngryDads",e),console.log("countAngryDads",t),console.table("playerData",this.playerData),0===t){var r=Math.floor(Math.random()*this.playerData.length);this.playerData.map(function(e){return e.isAngryDad=!1}),this.playerData[r].isAngryDad=!0}if(1<t){var n=e[Math.floor(Math.random()*t)].id;this.playerData.map(function(e){return e.isAngryDad=!1}),this.playerData.filter(function(e){return e.id===n})[0].isAngryDad=!0}},l.prototype.updatePlayer=function(t){var e=this.playerData.find(function(e){return e.id===t.id});if(e){var r=this.playerData.indexOf(e);if((this.playerData[r]=t).playerState===i.PlayerState.interacting){var n={damage:0,x:0,y:0,objectId:0};n&&(n.damage+=t.isAngryDad?-1:1,n.damage>a.OBJECTDATAMAXHEALTH&&(n.damage=a.OBJECTDATAMAXHEALTH),n.damage<0&&(n.damage=0)),t.isAngryDad}}},l.prototype.sendAllClients=function(e){this.airConsole.broadcast(e)},l.prototype.sendPlayerData=function(){this.sendAllClients({transactionType:i.TransactionType.PlayerData,playerData:this.playerData})},l.prototype.sendObjectData=function(){this.sendAllClients({transactionType:i.TransactionType.ObjectData,objectData:this.objectData})},l.prototype.sendServerData=function(){this.sendAllClients({transactionType:i.TransactionType.ServerData,serverData:this.serverData})},l);function l(){var t=this;this.playerData=[],this.objectData=[],this.updateServerCallbacks=new Set,this.updateControllerCallbacks=new Set,this.airConsole=new AirConsole,this.serverData=new i.ServerData(30,i.ServerState.initial),this.subscribeToAirConsole(),this.gameState=new o.GameStateJoin(this,3e3),s.on("newGameState",function(e){t.gameState=e}),this.initTick(),this.initMessageHandler()}a.Server=c},{"./connectedDevice":2,"./eventListener":3,"./index":4,"./server/gameStateJoin":8}],6:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("../eventListener").EventListener.get(),a=(i.prototype.tick=function(e){},i.prototype.enter=function(){},i.prototype.exit=function(){var e=new this.nextState(this.server);n.trigger("newGameState",e)},i.prototype.onExit=function(e){this.callback=e},i);function i(e){this.server=e,this.enter()}r.GameState=a},{"../eventListener":3}],7:[function(e,t,r){"use strict";var n,a=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(r,"__esModule",{value:!0});var i,o=e("./gameState"),s=e("../eventListener"),c=e("../connectedDevice"),l=(s.EventListener.get(),i=o.GameState,a(u,i),u.prototype.enter=function(){this.startTimer(),this.server.airConsole.broadcast({action:"updateState",data:{state:"choose",timerStarted:this.timerStarted,duration:3e3}})},u.prototype.tick=function(e){void 0!==this.timerStarted&&this.duration-(Date.now()-this.timerStarted)<=0&&(console.log("timer is up, next state"),this.exit())},u.prototype.exit=function(){var e=void 0,t=c.getAllDevices(),r=t.filter(function(e){return e.customStateData.wantAngry});e=0===r.length?t[t.length*Math.random()]:r[r.length*Math.random()],console.log("and the winner is:",e),c.getAllDevices().forEach(function(e){console.log(e.customStateData)}),i.prototype.exit.call(this)},u.prototype.startTimer=function(){console.log("player joined, starting timer"),this.timerStarted=Date.now()},u);function u(e){var t=i.call(this,e)||this;return t.duration=3e3,t.nextState=o.GameState,t}r.GameStateChoose=l},{"../connectedDevice":2,"../eventListener":3,"./gameState":6}],8:[function(e,t,r){"use strict";var n,a=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(r,"__esModule",{value:!0});var i,o=e("./gameState"),s=e("../eventListener"),c=e("./gameStateChoose"),l=s.EventListener.get(),u=(i=o.GameState,a(d,i),d.prototype.tick=function(e){void 0!==this.timerStarted&&this.duration-(Date.now()-this.timerStarted)<=0&&(console.log("timer is up, next state"),this.exit())},d.prototype.enter=function(){var t=this;this.deviceJoinedCallback=l.on("deviceJoined",function(e){t.timerStarted||t.startTimer(),t.server.airConsole.message(e.deviceId,{action:"updateState",data:{state:"join",timerStarted:t.timerStarted,duration:t.duration}})})},d.prototype.exit=function(){l.off("deviceJoined",this.deviceJoinedCallback),this.server.airConsole.setActivePlayers(4),i.prototype.exit.call(this)},d.prototype.startTimer=function(){console.log("player joined, starting timer"),this.timerStarted=Date.now()},d);function d(e,t){var r=i.call(this,e)||this;return r.duration=t,r.nextState=c.GameStateChoose,r}r.GameStateJoin=u},{"../eventListener":3,"./gameState":6,"./gameStateChoose":7}],9:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a,n,i=e("../common/index");(n=a=r.Views||(r.Views={}))[n.splashscreen=0]="splashscreen",n[n.characterselection=1]="characterselection",n[n.playscreen=2]="playscreen",n[n.endscreen=3]="endscreen";var o=(s.prototype.showView=function(e){document.querySelectorAll(a[e])[0].classList.add("visible")},s.prototype.hideView=function(e){document.querySelectorAll(a[e])[0].classList.remove("visible")},s.prototype.updateView=function(e){switch(console.log("new server state received",i.ServerState[e.serverState]),e.serverState){case i.ServerState.lobby:this.showView(a.splashscreen),this.lobby();break;case i.ServerState.characterSelection:this.showView(a.characterselection),this.characterselection();break;case i.ServerState.running:this.showView(a.playscreen),this.virtualController();break;case i.ServerState.final:this.showView(a.endscreen);break;default:console.error("not implemented",e)}},s.prototype.virtualController=function(){var t=this;document.querySelectorAll("playscreen > controller")[0].addEventListener("touchstart",function(e){t.startPos=[e.targetTouches[0].clientX,e.targetTouches[0].clientY]}),document.querySelectorAll("playscreen > controller")[0].addEventListener("touchmove",function(e){void 0!==t.startPos&&t.client.sendControllerData(new i.ControllerData(e.targetTouches[0].clientX-t.startPos[0],e.targetTouches[0].clientY-t.startPos[1]))}),document.querySelectorAll("playscreen > controller")[0].addEventListener("touchend",function(e){t.startPos=void 0})},s.prototype.lobby=function(){this.setTime(a.splashscreen)},s.prototype.characterselection=function(){var t=this;document.querySelectorAll("characterselection > button").forEach(function(e){t.client.toggleAngryDad()?(document.querySelectorAll("characterselection")[0].classList.add("isAngryDad"),console.log("You would like to be angry dad!")):(document.querySelectorAll("characterselection")[0].classList.remove("isAngryDad"),console.log("You would like to be a wichtel!"))}),this.setTime(a.characterselection)},s.prototype.setTime=function(t){var r=this,n=setInterval(function(){var e=r.client.getTime();document.querySelectorAll(a[t]+" > time")[0].innerHTML=e.toString(),0===e&&clearInterval(n)},1e3)},s);function s(e){this.client=e,this.startPos=void 0,this.client.onUpdateServerData(this.updateView.bind(this))}document.addEventListener("DOMContentLoaded",function(){var e=new i.Client;new o(e)})},{"../common/index":4}]},{},[9]);
//# sourceMappingURL=index.min.js.map
